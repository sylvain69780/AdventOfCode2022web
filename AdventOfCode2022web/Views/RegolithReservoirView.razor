@inherits PuzzleViewBase
<img style="width:100%; image-rendering:pixelated" src=@Visualize() />

@code {
    private RegolithReservoir? _solver => (RegolithReservoir)(Parent!.PuzzleBase!);

    public string _image64 = string.Empty;

    private string Visualize()
    {
        if (_solver == null || _solver.OccupiedPositions.Count == 0)
            return string.Empty;
        var Width = _solver!.xMax - _solver.xMin;
        var Height = _solver!.yMax - _solver.yMin;
        if (Width == 0 || Height == 0)
            return string.Empty;
        var response = string.Empty;
        using (MemoryStream outStream = new())
        {
            using (Image<Rgba32> img = new(Width, Height))
            {
                img.ProcessPixelRows(accessor =>
                {
                    for (int y = 0; y < accessor.Height; y++)
                    {
                        Span<Rgba32> pixelRow = accessor.GetRowSpan(y);
                        for (int x = 0; x < pixelRow.Length; x++)
                        {
                            ref Rgba32 pixel = ref pixelRow[x];
                            if (_solver.InitialPositions!.Contains((_solver.xMin + x, _solver.yMin + y)))
                                pixel = Color.Blue;
                            else if (_solver.OccupiedPositions!.Contains((_solver.xMin + x, _solver.yMin + y)))
                                pixel = Color.Green;
                            else if (_solver.SandPosition == (_solver.xMin + x, _solver.yMin + y))
                                pixel = Color.Red;
                        }
                    }
                });
                img.SaveAsPng(outStream);
            }
            response = "data:image/png;base64, " + Convert.ToBase64String(outStream.ToArray());
        }
        return response;
    }
}
